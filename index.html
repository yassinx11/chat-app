<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Number Chat</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f2f2f2;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
    }
    #chat-app {
      width: 400px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      padding: 20px;
      display: flex;
      flex-direction: column;
    }
    #chat-number {
      font-size: 18px;
      font-weight: bold;
      margin-bottom: 10px;
    }
    #messages {
      flex: 1;
      overflow-y: auto;
      border: 1px solid #ddd;
      padding: 10px;
      margin-bottom: 10px;
      height: 300px;
      background: #fafafa;
    }
    #messages div {
      margin-bottom: 5px;
    }
    input, button {
      padding: 10px;
      margin: 2px 0;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 14px;
    }
    button {
      background: #007bff;
      color: white;
      border: none;
      cursor: pointer;
    }
    button:hover {
      background: #0056b3;
    }
  </style>
</head>
<body>
<div id="chat-app">
  <div>
    <label>Chat Number: </label>
    <input type="text" id="numberInput" />
    <button onclick="setChatNumber()">Join</button>
  </div>
  <div id="chat-number"></div>
  <div id="messages"></div>
  <div>
    <input type="text" id="msgInput" placeholder="Type a message..." style="width: 75%;">
    <button onclick="sendMessage()">Send</button>
  </div>
</div>

<script>
let chatNumber = Math.floor(100000 + Math.random() * 900000).toString();
let pollInterval = null;
const API_KEY = "$2a$10$JMTp6qUSO6un7MHaOooepum9.jGrxXHtT/1eF1lJxozoZ2OYLLwlS"; // ðŸ‘ˆ put your jsonbin.io key here
let binId = null; // will hold bin id for each chat room

// init
document.getElementById("numberInput").value = chatNumber;
setChatNumber();

async function setChatNumber() {
  chatNumber = document.getElementById("numberInput").value.trim();
  document.getElementById("chat-number").innerText = "Connected to #" + chatNumber;

  // Create or load JSON bin for this chat number
  const binRes = await fetch(`https://api.jsonbin.io/v3/b/${chatNumber}`, {
    headers: { "X-Master-Key": API_KEY }
  });

  if (binRes.status === 200) {
    const data = await binRes.json();
    binId = chatNumber;
    renderMessages(data.record.messages || []);
  } else {
    // create new bin
    const createRes = await fetch("https://api.jsonbin.io/v3/b", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-Master-Key": API_KEY,
        "X-Bin-Name": chatNumber
      },
      body: JSON.stringify({ messages: [] })
    });
    const data = await createRes.json();
    binId = data.metadata.id;
  }

  if (pollInterval) clearInterval(pollInterval);
  pollInterval = setInterval(fetchMessages, 3000);
}

async function fetchMessages() {
  if (!binId) return;
  const res = await fetch(`https://api.jsonbin.io/v3/b/${binId}/latest`, {
    headers: { "X-Master-Key": API_KEY }
  });
  if (res.ok) {
    const data = await res.json();
    renderMessages(data.record.messages || []);
  }
}

function renderMessages(msgs) {
  const msgBox = document.getElementById("messages");
  msgBox.innerHTML = "";
  msgs.forEach(line => {
    const div = document.createElement("div");
    div.textContent = line;
    msgBox.appendChild(div);
  });
  msgBox.scrollTop = msgBox.scrollHeight;
}

async function sendMessage() {
  const msg = document.getElementById("msgInput").value.trim();
  if (!msg || !binId) return;

  // get latest
  const res = await fetch(`https://api.jsonbin.io/v3/b/${binId}/latest`, {
    headers: { "X-Master-Key": API_KEY }
  });
  const data = await res.json();
  const messages = data.record.messages || [];
  messages.push(msg);

  // update bin
  await fetch(`https://api.jsonbin.io/v3/b/${binId}`, {
    method: "PUT",
    headers: {
      "Content-Type": "application/json",
      "X-Master-Key": API_KEY
    },
    body: JSON.stringify({ messages })
  });

  document.getElementById("msgInput").value = "";
  renderMessages(messages);
}
</script>
</body>
</html>
